name: Pub.dev Score Validation

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-package:
    name: Validate Package Quality
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ” Verify Flutter Installation
        run: |
          flutter --version
          dart --version

      # ============================================
      # STATIC ANALYSIS
      # ============================================
      - name: ğŸ” Run Static Analysis
        run: |
          echo "Running dart analyze with fatal-infos..."
          dart analyze --fatal-infos

      # ============================================
      # CODE FORMATTING
      # ============================================
      - name: âœ¨ Check Code Formatting
        run: |
          echo "Checking code formatting..."
          dart format --output=none --set-exit-if-changed .

      # ============================================
      # TESTS
      # ============================================
      - name: ğŸ§ª Run Tests
        run: |
          echo "Running all tests with coverage..."
          flutter test --coverage

      - name: ğŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false  # Don't fail CI if codecov upload fails

      # ============================================
      # DOCUMENTATION
      # ============================================
      - name: ğŸ“š Generate Documentation
        run: |
          echo "Generating dartdoc..."
          dart doc . --output doc/api || true

          # Check for warnings (non-blocking)
          if grep -qi "warning\|error" doc/api/index.html 2>/dev/null; then
            echo "âš ï¸ Documentation warnings found"
          else
            echo "âœ“ Documentation generated successfully"
          fi

      # ============================================
      # DEPENDENCY CHECK
      # ============================================
      - name: ğŸ“¦ Check Dependencies
        run: |
          echo "Checking for outdated dependencies..."
          flutter pub outdated || true

      # ============================================
      # PUB SCORE (PANA)
      # ============================================
      - name: ğŸ¯ Run pana Analysis
        run: |
          echo "Installing pana..."
          dart pub global activate pana

          echo "Running pana analysis..."
          dart pub global run pana --no-warning

      - name: ğŸ“ Generate Score Report
        if: always()
        run: |
          echo "# ğŸ“Š Package Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All validation checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # EXAMPLE APP VALIDATION
  # ============================================
  validate-example:
    name: Validate Example App
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get Package Dependencies
        run: flutter pub get

      - name: ğŸ“¦ Get Example Dependencies
        working-directory: example
        run: flutter pub get

      - name: ğŸ” Analyze Example
        working-directory: example
        run: dart analyze --fatal-infos

      - name: âœ¨ Check Example Formatting
        working-directory: example
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ§ª Run Example Tests
        working-directory: example
        run: flutter test || echo "No example tests found"

      - name: ğŸ—ï¸ Build Example (Android)
        working-directory: example
        run: flutter build apk --debug

      - name: ğŸ—ï¸ Build Example (Web)
        working-directory: example
        run: flutter build web

  # ============================================
  # INTEGRATION TESTS
  # ============================================
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ§ª Run Integration Tests
        run: |
          if [ -d "integration_test" ]; then
            echo "Running integration tests..."
            flutter test integration_test/
          else
            echo "No integration tests found"
          fi

  # ============================================
  # FINAL STATUS CHECK
  # ============================================
  validation-complete:
    name: âœ… Validation Complete
    runs-on: ubuntu-latest
    needs: [validate-package, validate-example, integration-tests]
    if: always()

    steps:
      - name: Check All Jobs Status
        run: |
          if [ "${{ needs.validate-package.result }}" == "success" ] && \
             [ "${{ needs.validate-example.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "ğŸ‰ All validation checks passed!"
            exit 0
          else
            echo "âŒ Some validation checks failed"
            echo "Package: ${{ needs.validate-package.result }}"
            echo "Example: ${{ needs.validate-example.result }}"
            echo "Integration: ${{ needs.integration-tests.result }}"
            exit 1
          fi
